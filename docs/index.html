<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>私選ゲームBGMプレイヤー</title>
<script src="https://www.youtube.com/iframe_api"></script>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="player-wrapper">
  <div class="video-container">
    <div id="player"></div>
  </div>

  <div class="title-container">
    <div class="musicTitle" id="musicTitle"></div>
    <div class="gameTitle" id="gameTitle"></div>
  </div>

  <div class="playlist-selector">
    <label for="playlistSelect">プレイリスト切替：</label>
    <select id="playlistSelect"></select>
  </div>

  <div class="playlist-list" id="playlistList"></div>
</div>

<script>
let playlists = {};
let currentPlaylist = [];
let currentIndex = -1;
let player;
let firstClick = true;

// DOMロード後にJSON読み込み
document.addEventListener("DOMContentLoaded", () => {
  fetch('playlists.json')
    .then(res => res.json())
    .then(data => {
      playlists = data;

      // セレクトボックス作成
      const select = document.getElementById('playlistSelect');
      Object.keys(playlists).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = playlists[key].label || key;
        select.appendChild(option);
      });

      const firstKey = Object.keys(playlists)[0];
      currentPlaylist = playlists[firstKey]?.videos ?? [];

      // API準備確認
      if (window.YT && YT.Player) {
        createEmptyPlayer();
        renderPlaylistList();
      } else {
        window.onYouTubeIframeAPIReady = () => {
          createEmptyPlayer();
          renderPlaylistList();
        };
      }
    })
    .catch(err => console.error('JSON読み込みエラー:', err));
});

// プレイリスト切替
document.getElementById('playlistSelect').addEventListener('change', e => {
  const key = e.target.value;
  currentPlaylist = playlists[key]?.videos ?? [];
  currentIndex = -1;
  document.getElementById('musicTitle').textContent = '';
  document.getElementById('gameTitle').textContent = '';

  if (player) {
    player.stopVideo();
    player.destroy();
    player = null;
  }

  document.getElementById('player').innerHTML = '';
  firstClick = true;
  createEmptyPlayer();
  renderPlaylistList();
});

// 空プレイヤー生成
function createEmptyPlayer() {
  const playerDiv = document.getElementById('player');
  playerDiv.style.display = 'none';
  player = new YT.Player('player', {
    width: '100%',
    videoId: '',
    playerVars: { autoplay: 0, controls: 1 }
  });
}

// 動画ロード + 初回クリックで表示 + 再生
function loadVideo(index) {
  const video = currentPlaylist[index];
  if (!video) return;

  currentIndex = index;
  document.getElementById('musicTitle').textContent = video.musicTitle;
  document.getElementById('gameTitle').textContent = video.gameTitle;

  const playerDiv = document.getElementById('player');

  if (firstClick) {
    playerDiv.style.display = 'block';
    setTimeout(() => {
      player.loadVideoById({
        videoId: video.videoId,
        startSeconds: video.start ?? 0,
        endSeconds: video.end ?? undefined
      });
      player.playVideo();
    }, 50); // レンダリング確定待ち
    firstClick = false;
  } else {
    player.loadVideoById({
      videoId: video.videoId,
      startSeconds: video.start ?? 0,
      endSeconds: video.end ?? undefined
    });
    player.playVideo();
  }

  renderPlaylistList();
}

// プレイリスト描画
function renderPlaylistList() {
  const container = document.getElementById('playlistList');
  container.innerHTML = '';
  currentPlaylist.forEach((video, idx) => {
    const item = document.createElement('div');
    item.className = 'playlist-item' + (idx === currentIndex && currentIndex >= 0 ? ' selected' : '');
    item.innerHTML = `
      <img src="${video.thumbnail}" alt="${video.musicTitle}">
      <div class="titles">
        <div class="musicTitle">${video.musicTitle}</div>
        <div class="gameTitle">${video.gameTitle}</div>
      </div>
    `;
    item.addEventListener('click', () => loadVideo(idx));
    container.appendChild(item);
  });
}
</script>
</body>
</html>
